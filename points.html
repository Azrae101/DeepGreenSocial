<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Points - SustainaLearn</title>
    <link rel="icon" type="image/jpeg" href="images/logodgi.jpg">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="firebase-config.js"></script>

    <style>
        /* Combined CSS with enhanced features */
        :root {
            --primary-green: #2e7d32;
            --light-green: #4caf50;
            --dark-green: #1b5e20;
            --accent-color: #ff9800;
            --light-gray: #f5f5f5;
            --dark-gray: #424242;
            --white: #ffffff;
            --bronze: #cd7f32;
            --silver: #c0c0c0;
            --gold: #ffd700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background-color: var(--white);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo h1 {
            color: var(--primary-green);
            font-size: 24px;
            margin-left: 10px;
        }

        .logo-icon {
            font-size: 28px;
            color: var(--primary-green);
        }

        nav ul {
            display: flex;
            list-style: none;
        }

        nav ul li {
            margin-left: 20px;
            position: relative;
        }

        nav ul li a {
            text-decoration: none;
            color: var(--dark-gray);
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.3s ease;
            display: block;
        }

        nav ul li a:hover {
            background-color: var(--light-green);
            color: var(--white);
        }

        /* Dropdown Menu Styles */
        .dropdown {
            position: relative;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: var(--white);
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            z-index: 1000;
            margin-top: 5px;
        }

        .dropdown-content a {
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            color: var(--dark-gray);
            transition: all 0.3s ease;
        }

        .dropdown-content a:hover {
            background-color: var(--light-gray);
            color: var(--primary-green);
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown > a::after {
            content: ' ‚ñº';
            font-size: 0.7em;
            margin-left: 5px;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
        }

        .btn-login {
            background-color: transparent;
            color: var(--primary-green);
            border: 1px solid var(--primary-green);
        }

        .btn-register {
            background-color: var(--primary-green);
            color: var(--white);
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* Points Section Styles */
        .points-section {
            padding: 40px 0;
        }

        .section-title {
            text-align: center;
            margin-bottom: 40px;
            color: var(--primary-green);
        }

        .section-title h2 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .section-title p {
            color: var(--dark-gray);
            max-width: 700px;
            margin: 0 auto;
        }

        /* Dashboard Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stats-card {
            background-color: var(--white);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .stats-title {
            font-size: 1.2rem;
            color: var(--dark-green);
            font-weight: 600;
        }

        .stats-icon {
            font-size: 28px;
            color: var(--primary-green);
        }

        .stats-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-green);
            margin-bottom: 10px;
        }

        .stats-label {
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 20px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .progress-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--light-green), var(--primary-green));
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        /* Level Indicator */
        .level-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .level-badge {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: bold;
            font-size: 1.5rem;
            box-shadow: 0 4px 10px rgba(255, 152, 0, 0.3);
        }

        .level-info h3 {
            color: var(--dark-green);
            margin-bottom: 5px;
        }

        .level-info p {
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        /* Streak Calendar */
        .streak-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .streak-day {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
        }

        .streak-day.active {
            background-color: var(--light-green);
            color: var(--white);
            box-shadow: 0 2px 5px rgba(76, 175, 80, 0.3);
        }

        .streak-day.inactive {
            background-color: #f0f0f0;
            color: #999;
        }

        .streak-day.today {
            border: 2px solid var(--accent-color);
        }

        .streak-day .day-label {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 0.7rem;
            font-weight: normal;
        }

        /* Points Container (Original Style) */
        .points-container {
            background-color: var(--white);
            border-radius: 8px;
            padding: 40px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 0 auto 40px;
        }

        .total-points {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid var(--light-gray);
        }

        .points-value {
            font-size: 4rem;
            font-weight: bold;
            color: var(--primary-green);
            margin: 20px 0;
        }

        .points-label {
            font-size: 1.2rem;
            color: var(--dark-gray);
        }

        .points-breakdown {
            margin-bottom: 40px;
        }

        .breakdown-title {
            font-size: 1.5rem;
            color: var(--dark-green);
            margin-bottom: 20px;
            text-align: center;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .breakdown-category {
            font-weight: 500;
            color: var(--dark-gray);
        }

        .breakdown-points {
            font-weight: bold;
            color: var(--primary-green);
        }

        /* Daily Check-in Section */
        .checkin-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--white);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .checkin-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .checkin-text h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .btn-checkin {
            background-color: var(--accent-color);
            color: var(--white);
            padding: 12px 24px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-checkin:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }

        .btn-checkin:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Achievement Grid */
        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .achievement-card {
            background-color: var(--white);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .achievement-card:hover {
            transform: translateY(-5px);
        }

        .achievement-card.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .achievement-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .achievement-title {
            font-weight: 600;
            color: var(--dark-green);
            margin-bottom: 5px;
        }

        .achievement-desc {
            font-size: 0.9rem;
            color: var(--dark-gray);
            margin-bottom: 10px;
        }

        .achievement-points {
            display: inline-block;
            background-color: var(--light-gray);
            color: var(--primary-green);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Leaderboard */
        .leaderboard {
            margin-top: 20px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: var(--white);
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .leaderboard-item.current-user {
            background-color: rgba(76, 175, 80, 0.1);
            border-left: 4px solid var(--primary-green);
        }

        .leaderboard-rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .rank-1 { background-color: var(--gold); color: white; }
        .rank-2 { background-color: var(--silver); color: white; }
        .rank-3 { background-color: var(--bronze); color: white; }
        .rank-other { background-color: var(--light-gray); color: var(--dark-gray); }

        .leaderboard-user {
            flex: 1;
        }

        .leaderboard-user strong {
            color: var(--dark-green);
            display: block;
            margin-bottom: 3px;
        }

        .leaderboard-user span {
            font-size: 0.9rem;
            color: var(--dark-gray);
        }

        .leaderboard-points {
            font-weight: bold;
            color: var(--primary-green);
            font-size: 1.1rem;
        }

        /* Impact Stats */
        .impact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .impact-item {
            background-color: var(--white);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .impact-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .impact-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-green);
            margin-bottom: 5px;
        }

        .impact-label {
            font-size: 0.9rem;
            color: var(--dark-gray);
        }

        /* History Table */
        .history-container {
            background-color: var(--white);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th {
            text-align: left;
            padding: 15px;
            background-color: var(--light-gray);
            color: var(--dark-green);
            font-weight: 600;
            border-bottom: 2px solid #ddd;
        }

        .history-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .history-table tr:hover {
            background-color: rgba(76, 175, 80, 0.05);
        }

        .points-positive {
            color: var(--primary-green);
            font-weight: bold;
        }

        .points-negative {
            color: #e53935;
            font-weight: bold;
        }

        /* Events List */
        .events-list {
            margin-top: 30px;
        }

        .events-title {
            font-size: 1.5rem;
            color: var(--dark-green);
            margin-bottom: 20px;
            text-align: center;
        }

        .event-item {
            background-color: var(--light-gray);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-name {
            font-weight: 500;
        }

        .event-points {
            color: var(--primary-green);
            font-weight: bold;
        }

        .no-events {
            text-align: center;
            color: var(--dark-gray);
            font-style: italic;
            padding: 20px;
        }

        /* Two Column Layout */
        .two-column-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .two-column-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Footer */
        footer {
            background-color: var(--dark-green);
            color: var(--white);
            padding: 40px 0 20px;
            margin-top: 60px;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .footer-column h3 {
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .footer-column ul {
            list-style: none;
        }

        .footer-column ul li {
            margin-bottom: 10px;
        }

        .footer-column ul li a {
            color: var(--light-gray);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-column ul li a:hover {
            color: var(--accent-color);
        }

        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .social-icon {
            display: inline-block;
            width: 40px;
            height: 40px;
            background-color: var(--light-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            text-decoration: none;
            transition: background-color 0.3s ease;
        }

        .social-icon:hover {
            background-color: var(--accent-color);
        }

        .copyright {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }

        /* Trash Competition Styles */
        .trash-competition {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 40px;
            color: var(--white);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            margin-bottom: 40px;
        }

        .trash-competition h3 {
            font-size: 2rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .trash-competition > p {
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 30px;
            opacity: 0.95;
        }

        .trash-upload-section {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 30px;
            backdrop-filter: blur(10px);
            margin-bottom: 25px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
            margin-bottom: 20px;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.2);
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .file-input-label:hover {
            background-color: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
        }

        .file-input-label .icon {
            font-size: 1.5rem;
        }

        .selected-file {
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(76, 175, 80, 0.3);
            border-radius: 6px;
            text-align: center;
            font-size: 0.9rem;
        }

        .btn-submit-trash {
            width: 100%;
            padding: 15px 30px;
            background-color: var(--accent-color);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
        }

        .btn-submit-trash:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.6);
        }

        .btn-submit-trash:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .trash-status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            display: none;
        }

        .trash-status.success {
            background-color: rgba(76, 175, 80, 0.3);
            display: block;
        }

        .trash-status.error {
            background-color: rgba(244, 67, 54, 0.3);
            display: block;
        }

        .trash-rewards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .reward-card {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .reward-card .medal {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .reward-card .place {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .reward-card .points {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .trash-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .trash-stat-item {
            text-align: center;
        }

        .trash-stat-item .value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .trash-stat-item .label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                padding: 15px 0;
            }

            nav ul {
                margin: 15px 0;
            }

            .auth-buttons {
                margin-top: 10px;
            }

            .points-container {
                padding: 20px;
            }

            .points-value {
                font-size: 3rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .checkin-content {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }

            .achievement-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .stats-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-container">
            <div class="logo">
                <img src="images/logodgi.jpg" alt="Social & Green Logo" style="height: 40px; width: auto;">
                <h1>Social & Green</h1>
            </div>
            <nav>
                <ul>
                    <li class="dropdown">
                        <a href="index.html">Home</a>
                        <div class="dropdown-content">
                            <a href="index.html#events">Events</a>
                            <a href="index.html#news">News</a>
                            <a href="index.html#map">Sustainable Aarhus</a>
                        </div>
                    </li>
                    <li><a href="game-overview.html">Games</a></li>
                    <li><a href="community.html">Community</a></li>
                </ul>
            </nav>
            <div class="auth-buttons" id="authButtons">
                <!-- Buttons will be dynamically inserted here -->
            </div>
        </div>
    </header>

    <!-- Points Section -->
    <section class="points-section">
        <div class="container">
            <div class="section-title">
                <h2>My Sustainability Dashboard</h2>
                <p>Track your progress and see how your actions are making a difference</p>
            </div>

            <!-- Daily Check-in -->
            <div class="checkin-container" id="checkinSection">
                <div class="checkin-content">
                    <div class="checkin-text">
                        <h3>üåû Daily Check-in</h3>
                        <p>Check in today to earn 10 points and continue your streak!</p>
                        <p id="checkinStatus">Last check-in: <span id="lastCheckinDate">Never</span></p>
                    </div>
                    <button class="btn-checkin pulse" id="checkinBtn">Check In Today +10 pts</button>
                </div>
            </div>

            <!-- Main Dashboard Grid -->
            <div class="dashboard-grid">
                <!-- Points Summary -->
                <div class="stats-card">
                    <div class="stats-header">
                        <h2 class="stats-title">Total Points</h2>
                        <div class="stats-icon">üèÜ</div>
                    </div>
                    <div class="stats-value" id="totalPointsDashboard">0</div>
                    <div class="stats-label">Lifetime points earned</div>
                    
                    <div class="level-container">
                        <div class="level-badge" id="levelBadge">1</div>
                        <div class="level-info">
                            <h3>Level <span id="currentLevel">1</span></h3>
                            <p><span id="pointsToNext">100</span> points to next level</p>
                        </div>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Progress to Level <span id="nextLevel">2</span></span>
                            <span><span id="currentProgress">0</span>/<span id="levelRequirement">100</span></span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="levelProgress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Streak Tracker -->
                <div class="stats-card">
                    <div class="stats-header">
                        <h2 class="stats-title">Current Streak</h2>
                        <div class="stats-icon">üî•</div>
                    </div>
                    <div class="stats-value" id="currentStreak">0</div>
                    <div class="stats-label">Days in a row</div>
                    <p style="margin-top: 15px; color: var(--dark-gray); font-size: 0.9rem;">
                        Check in daily to maintain your streak. 7-day streak bonus: 70 points!
                    </p>
                    
                    <div class="streak-calendar" id="streakCalendar">
                        <!-- Streak days will be generated by JavaScript -->
                    </div>
                </div>

                <!-- Monthly Rank -->
                <div class="stats-card">
                    <div class="stats-header">
                        <h2 class="stats-title">Monthly Rank</h2>
                        <div class="stats-icon">üìä</div>
                    </div>
                    <div class="stats-value" id="monthlyRank">-</div>
                    <div class="stats-label">This month's position</div>
                    <div style="margin-top: 20px;">
                        <p style="color: var(--dark-gray); font-size: 0.9rem; margin-bottom: 10px;">
                            <strong>Monthly Points:</strong> <span id="monthlyPoints">0</span> pts
                        </p>
                        <p style="color: var(--dark-gray); font-size: 0.9rem;">
                            <strong>Next rank up:</strong> <span id="nextRankPoints">0</span> <span id="nextRankLabel">pts</span>
                        </p>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Monthly Progress</span>
                            <span><span id="monthlyProgressPercent">0</span>%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="monthlyProgress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Original Points Container -->
            <div class="points-container">
                <div class="total-points">
                    <div class="points-label">Total Points Earned</div>
                    <div class="points-value" id="totalPoints">0</div>
                    <div class="points-label">Keep up the great work!</div>
                </div>
                
                <div class="points-breakdown">
                    <h3 class="breakdown-title">Points Breakdown</h3>
                    <div class="breakdown-item">
                        <span class="breakdown-category">Events Attended</span>
                        <span class="breakdown-points" id="eventsPoints">0 points</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-category">Games Played</span>
                        <span class="breakdown-points" id="gamesPoints">0 points</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-category">Articles Read</span>
                        <span class="breakdown-points" id="articlesPoints">0 points</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-category">Quizzes Completed</span>
                        <span class="breakdown-points" id="quizzesPoints">0 points</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-category">Daily Check-ins</span>
                        <span class="breakdown-points" id="dailyPoints">0 points</span>
                    </div>
                </div>
                
                <div class="events-list">
                    <h3 class="events-title">Events You Have Signed Up For</h3>
                    <p style="text-align: center; color: var(--dark-gray); margin-bottom: 10px; font-size: 0.95rem;">Remember to check the event links for any updates or changes.</p>
                    <p style="text-align: center; color: var(--dark-gray); margin-bottom: 20px; font-size: 0.9rem; font-style: italic;">NB: Some of the events require sign ups on their page</p>
                    <div id="eventsList">
                        <!-- Events will be listed here -->
                    </div>
                </div>
            </div>

            <!-- Add this to points.html after the points history section (around line 650): -->
            <div style="text-align: center; margin: 40px 0;">
                <a href="certificate.html" class="btn" style="background-color: var(--accent-color); color: white; padding: 15px 30px; font-size: 1.2rem; text-decoration: none; display: inline-flex; align-items: center; gap: 10px;">
                    üèÖ View My Certificate
                </a>
            </div>

            <!-- Trash Collection Competition -->
            <div class="trash-competition">
                <h3>üóëÔ∏è Trash Collection Challenge</h3>
                <p>Upload a photo of the trash you collect. The top contributors each month get bonus points!</p>
                
                <div class="trash-upload-section">
                    <div class="file-input-wrapper">
                        <input type="file" id="trashUpload" accept="image/*">
                        <label for="trashUpload" class="file-input-label">
                            <span class="icon">üì∏</span>
                            <span id="fileLabel">Choose a photo or drag & drop</span>
                        </label>
                    </div>
                    <div id="selectedFile" class="selected-file" style="display: none;"></div>
                    
                    <button class="btn-submit-trash" id="submitTrashBtn">
                        <span>Submit Your Contribution</span>
                    </button>
                    
                    <div id="trashStatus" class="trash-status"></div>
                </div>

                <div class="trash-rewards">
                    <div class="reward-card">
                        <div class="medal">ü•á</div>
                        <div class="place">1st Place</div>
                        <div class="points">+500 pts</div>
                    </div>
                    <div class="reward-card">
                        <div class="medal">ü•à</div>
                        <div class="place">2nd Place</div>
                        <div class="points">+250 pts</div>
                    </div>
                    <div class="reward-card">
                        <div class="medal">ü•â</div>
                        <div class="place">3rd Place</div>
                        <div class="points">+100 pts</div>
                    </div>
                </div>

                <div class="trash-stats">
                    <div class="trash-stat-item">
                        <div class="value" id="trashPoints">0</div>
                        <div class="label">Your Submissions</div>
                    </div>
                    <div class="trash-stat-item">
                        <div class="value" id="trashRank">-</div>
                        <div class="label">Monthly Rank</div>
                    </div>
                    <div class="trash-stat-item">
                        <div class="value" id="trashThisMonth">0</div>
                        <div class="label">This Month</div>
                    </div>
                </div>
            </div>

            <!-- Impact Statistics -->
            <div class="stats-card" style="margin-bottom: 40px;">
                <div class="stats-header">
                    <h2 class="stats-title">Your Environmental Impact</h2>
                    <div class="stats-icon">üåç</div>
                </div>
                <p style="color: var(--dark-gray); margin-bottom: 20px;">
                    Based on your activities, you've helped save:
                </p>
                
                <div class="impact-grid">
                    <div class="impact-item">
                        <div class="impact-icon">‚òÅÔ∏è</div>
                        <div class="impact-value" id="co2Saved">0 kg</div>
                        <div class="impact-label">CO2 Emissions Saved</div>
                    </div>
                    <div class="impact-item">
                        <div class="impact-icon">üíß</div>
                        <div class="impact-value" id="waterSaved">0 L</div>
                        <div class="impact-label">Water Conserved</div>
                    </div>
                    <div class="impact-item">
                        <div class="impact-icon">üóëÔ∏è</div>
                        <div class="impact-value" id="wasteDiverted">0 kg</div>
                        <div class="impact-label">Waste Diverted</div>
                    </div>
                    <div class="impact-item">
                        <div class="impact-icon">üå≥</div>
                        <div class="impact-value" id="equivalentTrees">0</div>
                        <div class="impact-label">Equivalent Trees Planted</div>
                    </div>
                </div>
            </div>

            <!-- Two Column: Achievements and Leaderboard -->
            <div class="two-column-grid">
                <!-- Achievements -->
                <div class="stats-card">
                    <div class="stats-header">
                        <h2 class="stats-title">Achievements</h2>
                        <div class="stats-icon">üèÖ</div>
                    </div>
                    <p style="color: var(--dark-gray); margin-bottom: 20px;">
                        <span id="achievementsCount">0</span> of <span id="totalAchievements">10</span> unlocked
                    </p>
                    
                    <div class="achievement-grid" id="achievementsContainer">
                        <!-- Achievements will be generated by JavaScript -->
                    </div>
                </div>

                <!-- Leaderboard -->
                <div class="stats-card">
                    <div class="stats-header">
                        <h2 class="stats-title">Top Contributors This Month</h2>
                        <div class="stats-icon">üëë</div>
                    </div>
                    
                    <div class="leaderboard" id="leaderboardContainer">
                        <!-- Leaderboard will be generated by JavaScript -->
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="showFullLeaderboard()" style="background-color: var(--light-gray); color: var(--dark-green);">
                            View Full Leaderboard ‚Üí
                        </button>
                    </div>
                </div>
            </div>

            <!-- Points History -->
            <div class="history-container">
                <div class="stats-header">
                    <h2 class="stats-title">Points History</h2>
                    <div class="stats-icon">üìà</div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn" id="filterAll" style="background-color: var(--primary-green); color: white; margin-right: 10px;">All</button>
                    <button class="btn" id="filterEarned" style="background-color: var(--light-gray); color: var(--dark-green); margin-right: 10px;">Points Earned</button>
                    <button class="btn" id="filterSpent" style="background-color: var(--light-gray); color: var(--dark-green);">Points Spent</button>
                </div>
                
                <table class="history-table" id="pointsHistory">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Points</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- History will be generated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>SustainaLearn</h3>
                    <p>Making sustainability accessible, engaging, and actionable for everyone.</p>
                    <div class="social-links">
                        <a href="#" class="social-icon">f</a>
                        <a href="#" class="social-icon">in</a>
                        <a href="#" class="social-icon">ig</a>
                    </div>
                </div>
                <div class="footer-column">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="index.html#events">Events</a></li>
                        <li><a href="game.html">Games</a></li>
                        <li><a href="index.html#news">News</a></li>
                        <li><a href="points.html">My Points</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Contact Us</h3>
                    <ul>
                        <li>123 Green Street, Eco City</li>
                        <li>+1 (123) 456-7890</li>
                        <li>socialandgreen@gmail.com</li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2023 SustainaLearn. All rights reserved. | Designed with üíö for a greener planet</p>
            </div>
        </div>
    </footer>

    <script>
        let currentUserData = null;
        let currentUserId = null;

        // Auth state listener - Load everything once user is authenticated
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                // Redirect to login if not authenticated
                window.location.href = 'login.html';
                return;
            }
            
            currentUserId = user.uid;
            console.log('User authenticated:', currentUserId);
            
            try {
                // Get user data from Firestore
                const userRef = db.collection('users').doc(user.uid);
                const userSnap = await userRef.get();
                
                if (!userSnap.exists) {
                    console.log('Creating new user document...');
                    // Create user document with default values
                    const now = new Date();
                    const monthKey = `${now.getFullYear()}-${now.getMonth()}`;
                    
                    await userRef.set({
                        email: user.email,
                        name: user.displayName || 'User',
                        points: 0,
                        totalUploads: 0,
                        streak: 0,
                        level: 1,
                        achievements: [],
                        dailyCheckins: [],
                        eventsAttended: [],
                        events: [],
                        pointsHistory: [],
                        monthlyPoints: { [monthKey]: 0 },
                        gamePoints: 0,
                        articlesRead: [],
                        articlesQuizPassed: [],
                        trashCollected: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    const newSnap = await userRef.get();
                    currentUserData = newSnap.data();
                } else {
                    currentUserData = userSnap.data();
                }
                
                console.log('User data loaded:', currentUserData);
                
                // Load dashboard data
                loadDashboardFromFirebase();
                updateAuthButtons(user);
                initCheckInFirebase();
                initTrashCompetition(user);
                
            } catch (error) {
                console.error('Error loading user data:', error);
                alert('Error loading your data. Please refresh the page.');
            }
        });
        
        function updateAuthButtons(user) {
            const authButtons = document.getElementById('authButtons');
            
            authButtons.innerHTML = `
                <span style="margin-right: 15px; color: var(--primary-green);">Welcome, ${user.displayName || 'User'}</span>
                <button class="btn btn-login" onclick="window.location.href='points.html'">My Points</button>
                <button class="btn btn-register" id="logoutBtn">Logout</button>
            `;
            
            document.getElementById('logoutBtn').addEventListener('click', async function() {
                await auth.signOut();
                window.location.href = 'index.html';
            });
        }
            
            // Update auth buttons
            updateAuthButtons();
            
            // Load all dashboard data
            loadDashboardData(user);
            loadPointsBreakdown(user);
            loadEventsList(user);
            initCheckIn(user);
            loadAchievements(user);
            loadLeaderboard(allUsers, user);
            loadPointsHistory(user);
            calculateImpactStats(user);
            initHistoryFilters();
        });
        
        function initializeUserData(currentUser) {
            // Get fresh user data from localStorage
            const users = JSON.parse(localStorage.getItem('sustainalearn_users')) || [];
            const userIndex = users.findIndex(u => u.username === currentUser.username);
            
            if (userIndex === -1) return currentUser;
            
            const user = users[userIndex];
            
            // Ensure all required fields exist
            if (!user.points) user.points = 0;
            if (!user.streak) user.streak = 0;
            if (!user.level) user.level = 1;
            if (!user.achievements) user.achievements = [];
            if (!user.dailyCheckins) user.dailyCheckins = [];
            if (!user.eventsAttended) user.eventsAttended = [];
            if (!user.pointsHistory) user.pointsHistory = [];
            if (!user.monthlyPoints) user.monthlyPoints = {};
            if (!user.gamePoints) user.gamePoints = 0;
            if (!user.articlesRead) user.articlesRead = [];
            if (!user.articlesQuizPassed) user.articlesQuizPassed = [];
            
            // Initialize monthly points for current month
            const now = new Date();
            const monthKey = `${now.getFullYear()}-${now.getMonth()}`;
            if (!user.monthlyPoints[monthKey]) {
                user.monthlyPoints[monthKey] = 0;
            }
            
            // Update localStorage
            users[userIndex] = user;
            localStorage.setItem('sustainalearn_users', JSON.stringify(users));
            localStorage.setItem('sustainalearn_currentUser', JSON.stringify(user));
            
            return user;
        }
        
        function updateAuthButtons() {
            const authButtons = document.getElementById('authButtons');
            const currentUser = JSON.parse(localStorage.getItem('sustainalearn_currentUser'));
            
            if (currentUser) {
                authButtons.innerHTML = `
                    <span style="margin-right: 15px; color: var(--primary-green);">Welcome, ${currentUser.firstName}</span>
                    <a href="index.html" class="btn btn-login">Home</a>
                    <button class="btn btn-register" id="logoutBtn">Logout</button>
                `;
                
                document.getElementById('logoutBtn').addEventListener('click', function() {
                    localStorage.removeItem('sustainalearn_currentUser');
                    window.location.href = 'index.html';
                });
            } else {
                authButtons.innerHTML = `
                    <button class="btn btn-login" id="loginBtn">Login</button>
                    <button class="btn btn-register" id="registerBtn">Register</button>
                `;
                
                document.getElementById('loginBtn').addEventListener('click', function() {
                    window.location.href = 'login.html';
                });
                
                document.getElementById('registerBtn').addEventListener('click', function() {
                    window.location.href = 'register.html';
                });
            }
        }
        
        function loadDashboardFromFirebase() {
            if (!currentUserData) return;
            
            const userData = currentUserData;

            // Update points displays
            document.getElementById("totalPoints").textContent = userData.points || 0;
            document.getElementById("totalPointsDashboard").textContent = userData.points || 0;
            
            // Calculate level (every 100 points = 1 level)
            const level = Math.floor((userData.points || 0) / 100) + 1;
            const pointsInCurrentLevel = (userData.points || 0) % 100;
            const pointsToNextLevel = 100 - pointsInCurrentLevel;
            
            // Update level info
            document.getElementById('currentLevel').textContent = level;
            document.getElementById('levelBadge').textContent = level;
            document.getElementById('nextLevel').textContent = level + 1;
            document.getElementById('currentProgress').textContent = pointsInCurrentLevel;
            document.getElementById('pointsToNext').textContent = pointsToNextLevel;
            document.getElementById('levelRequirement').textContent = 100;
            
            // Update progress bar
            const progressPercent = (pointsInCurrentLevel / 100) * 100;
            document.getElementById('levelProgress').style.width = `${progressPercent}%`;
            
            // Update streak
            document.getElementById('currentStreak').textContent = userData.streak || 0;
            
            // Update monthly points
            const now = new Date();
            const monthKey = `${now.getFullYear()}-${now.getMonth()}`;
            const monthlyPoints = userData.monthlyPoints?.[monthKey] || 0;
            document.getElementById('monthlyPoints').textContent = monthlyPoints;
            
            // Generate streak calendar
            generateStreakCalendar(userData.dailyCheckins || []);
            
            // Load other data
            loadPointsBreakdownFirebase();
            loadEventsListFirebase();
            loadPointsHistoryFirebase();
            loadAchievementsFirebase();
            calculateImpactStatsFirebase();
        }
        
        function loadPointsBreakdownFirebase() {
            if (!currentUserData) return;
            
            // Calculate points from different sources
            const eventsPoints = (currentUserData.eventsAttended?.length || 0) * 10;
            const gamesPoints = currentUserData.gamePoints || 0;
            const articlesPoints = (currentUserData.articlesRead?.length || 0) * 50;
            const quizzesPoints = (currentUserData.articlesQuizPassed?.length || 0) * 100;
            const dailyPoints = calculateDailyPoints(currentUserData);
            const trashPoints = (currentUserData.trashCollected?.length || 0);

            document.getElementById('trashPoints').textContent = `${trashPoints} item(s)`;
            document.getElementById('eventsPoints').textContent = `${eventsPoints} points`;
            document.getElementById('gamesPoints').textContent = `${gamesPoints} points`;
            document.getElementById('articlesPoints').textContent = `${articlesPoints} points`;
            document.getElementById('quizzesPoints').textContent = `${quizzesPoints} points`;
            document.getElementById('dailyPoints').textContent = `${dailyPoints} points`;
        }
        
        function loadEventsListFirebase() {
            if (!currentUserData) return;
            
            const container = document.getElementById('eventsList');
            const userEvents = currentUserData.events || [];
            
            // Helper function to parse Danish date format
            function parseDanishDate(dateStr) {
                const datePart = dateStr.split(' - ')[0];
                const [day, month, year] = datePart.split('/').map(num => parseInt(num, 10));
                return new Date(year, month - 1, day, 23, 59, 59);
            }
            
            // Filter out past events
            const today = new Date();
            const upcomingEventIds = userEvents.filter(eventId => {
                const event = typeof eventData !== 'undefined' ? eventData.find(e => e.id === eventId) : null;
                if (!event || !event.date) return false;
                return parseDanishDate(event.date) >= today;
            });
            
            if (upcomingEventIds.length === 0) {
                container.innerHTML = `
                    <div class="no-events">You haven't signed up for any upcoming events.</div>
                `;
                return;
            }
            
            // Load actual events data from events.js
            container.innerHTML = '';
            
            upcomingEventIds.forEach(eventId => {
                const event = typeof eventData !== 'undefined' ? eventData.find(e => e.id === eventId) : null;
                
                const eventItem = document.createElement('div');
                eventItem.className = 'event-item';
                eventItem.innerHTML = `
                    <span class="event-name">${event ? event.name : 'Event'}</span>
                    <span class="event-points">+10 pts (signup)</span>
                `;
                container.appendChild(eventItem);
            });
        }
        
        function loadPointsHistoryFirebase() {
            if (!currentUserData) return;
            
            const tbody = document.getElementById('historyTableBody');
            const history = currentUserData.pointsHistory || [];
            
            if (history.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 30px; color: var(--dark-gray);">
                            No points history yet. Start earning points by checking in daily and attending events!
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by date (newest first)
            history.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = '';
            
            history.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(item.date)}</td>
                    <td>${item.description}</td>
                    <td class="${item.type === 'earned' || item.type === 'bonus' ? 'points-positive' : 'points-negative'}">
                        ${item.type === 'earned' || item.type === 'bonus' ? '+' : '-'}${item.points}
                    </td>
                    <td>
                        <span style="display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; 
                               background-color: ${getTypeColor(item.type)}; color: white;">
                            ${item.type}
                        </span>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function loadAchievementsFirebase() {
            if (!currentUserData) return;
            
            const container = document.getElementById('achievementsContainer');
            const userAchievements = currentUserData.achievements || [];
            
            document.getElementById('achievementsCount').textContent = userAchievements.length;
            document.getElementById('totalAchievements').textContent = achievementsData.length;
            
            container.innerHTML = '';
            
            achievementsData.forEach(achievement => {
                const hasAchievement = userAchievements.includes(achievement.id);
                
                const card = document.createElement('div');
                card.className = `achievement-card ${hasAchievement ? '' : 'locked'}`;
                card.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-title">${achievement.name}</div>
                    <div class="achievement-desc">${achievement.description}</div>
                    <div class="achievement-points">+${achievement.points} pts</div>
                `;
                
                if (hasAchievement) {
                    card.style.border = '2px solid var(--primary-green)';
                }
                
                container.appendChild(card);
            });
        }
        
        function calculateImpactStatsFirebase() {
            if (!currentUserData) return;
            
            // Calculate based on points and activities
            const points = currentUserData.points || 0;
            
            // Rough estimates:
            // - 10 points = 1 kg CO2 saved
            // - 10 points = 50 L water saved  
            // - 10 points = 0.5 kg waste diverted
            // - 100 kg CO2 = 1 tree equivalent
            
            const co2Saved = (points / 10) * 1; // kg
            const waterSaved = (points / 10) * 50; // liters
            const wasteDiverted = (points / 10) * 0.5; // kg
            const equivalentTrees = Math.floor(co2Saved / 100);
            
            document.getElementById('co2Saved').textContent = `${co2Saved.toFixed(1)} kg`;
            document.getElementById('waterSaved').textContent = `${waterSaved.toFixed(0)} L`;
            document.getElementById('wasteDiverted').textContent = `${wasteDiverted.toFixed(1)} kg`;
            document.getElementById('equivalentTrees').textContent = equivalentTrees;
        }
        
        function initCheckInFirebase() {
            if (!currentUserData || !currentUserId) return;
            
            const checkinBtn = document.getElementById('checkinBtn');
            const today = new Date().toISOString().split('T')[0];
            const hasCheckedInToday = (currentUserData.dailyCheckins || []).includes(today);
            
            if (hasCheckedInToday) {
                checkinBtn.disabled = true;
                checkinBtn.textContent = 'Already Checked In Today';
            }
            
            checkinBtn.addEventListener('click', async function() {
                if (hasCheckedInToday) return;
                
                const userRef = db.collection('users').doc(currentUserId);
                
                await userRef.update({
                    dailyCheckins: firebase.firestore.FieldValue.arrayUnion(today),
                    points: firebase.firestore.FieldValue.increment(10),
                    streak: firebase.firestore.FieldValue.increment(1)
                });
                
                // Refresh data
                const userSnap = await userRef.get();
                currentUserData = userSnap.data();
                loadDashboardFromFirebase();
                
                alert('‚úÖ Check-in successful! +10 points added.');
            });
        }
        
        const achievementsData = [
            { id: 'first_event', name: 'First Step', description: 'Attend your first event', points: 100, icon: 'üéØ' },
            { id: 'week_streak', name: 'Consistency', description: 'Check in for 7 days straight', points: 200, icon: 'üî•' },
            { id: 'event_regular', name: 'Event Regular', description: 'Attend 5 events', points: 250, icon: 'üìÖ' },
            { id: 'quiz_master', name: 'Quiz Master', description: 'Score 100% on 3 quizzes', points: 150, icon: 'üß†' },
            { id: 'eco_warrior', name: 'Eco Warrior', description: 'Earn 1000 total points', points: 500, icon: 'üõ°Ô∏è' },
            { id: 'community_hero', name: 'Community Hero', description: 'Invite 3 friends to events', points: 300, icon: 'üë•' },
            { id: 'waste_reducer', name: 'Waste Reducer', description: 'Attend 3 cleaning events', points: 200, icon: 'üóëÔ∏è' },
            { id: 'green_thumb', name: 'Green Thumb', description: 'Participate in gardening events', points: 150, icon: 'üåø' },
            { id: 'early_adopter', name: 'Early Adopter', description: 'Join in first month', points: 100, icon: 'üöÄ' },
            { id: 'level_5', name: 'Level 5 Champion', description: 'Reach level 5', points: 400, icon: 'üèÜ' }
        ];
        
        function loadAchievements(user) {
            const container = document.getElementById('achievementsContainer');
            const userAchievements = user.achievements || [];
            
            document.getElementById('achievementsCount').textContent = userAchievements.length;
            document.getElementById('totalAchievements').textContent = achievementsData.length;
            
            container.innerHTML = '';
            
            achievementsData.forEach(achievement => {
                const hasAchievement = userAchievements.includes(achievement.id);
                
                const card = document.createElement('div');
                card.className = `achievement-card ${hasAchievement ? '' : 'locked'}`;
                card.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-title">${achievement.name}</div>
                    <div class="achievement-desc">${achievement.description}</div>
                    <div class="achievement-points">+${achievement.points} pts</div>
                `;
                
                if (hasAchievement) {
                    card.style.border = '2px solid var(--primary-green)';
                }
                
                container.appendChild(card);
            });
        }
        
        function loadLeaderboard(allUsers, currentUser) {
            const container = document.getElementById('leaderboardContainer');
            const now = new Date();
            const monthKey = `${now.getFullYear()}-${now.getMonth()}`;
            
            // Filter users with monthly points
            const usersWithMonthlyPoints = allUsers.filter(user => 
                user.monthlyPoints && user.monthlyPoints[monthKey]
            );
            
            // Sort by monthly points
            usersWithMonthlyPoints.sort((a, b) => 
                (b.monthlyPoints[monthKey] || 0) - (a.monthlyPoints[monthKey] || 0)
            );
            
            // Take top 5
            const topUsers = usersWithMonthlyPoints.slice(0, 5);
            
            // Find current user's rank
            const currentUserRank = usersWithMonthlyPoints.findIndex(u => 
                u.username === currentUser.username
            ) + 1;
            
            document.getElementById('monthlyRank').textContent = 
                currentUserRank > 0 ? `#${currentUserRank}` : 'Unranked';
            
            // Update monthly progress
            if (topUsers.length > 0) {
                const topPoints = topUsers[0].monthlyPoints[monthKey] || 0;
                const currentPoints = currentUser.monthlyPoints?.[monthKey] || 0;
                const progressPercent = topPoints > 0 ? (currentPoints / topPoints) * 100 : 0;
                
                document.getElementById('monthlyProgressPercent').textContent = 
                    Math.round(progressPercent);
                document.getElementById('monthlyProgress').style.width = `${progressPercent}%`;
                
                // Find next rank points
                if (currentUserRank === 1) {
                    document.getElementById('nextRankPoints').textContent = 'You are number one';
                    document.getElementById('nextRankLabel').textContent = '';
                } else if (currentUserRank > 1 && currentUserRank <= topUsers.length) {
                    const nextUser = topUsers[currentUserRank - 2];
                    const nextPoints = nextUser.monthlyPoints[monthKey] || 0;
                    const pointsNeeded = nextPoints - currentPoints + 1;
                    document.getElementById('nextRankPoints').textContent = pointsNeeded;
                    document.getElementById('nextRankLabel').textContent = 'pts';
                } else {
                    document.getElementById('nextRankPoints').textContent = 'N/A';
                    document.getElementById('nextRankLabel').textContent = '';
                }
            }
            
            // Generate leaderboard
            container.innerHTML = '';
            
            topUsers.forEach((user, index) => {
                const isCurrentUser = user.username === currentUser.username;
                const rank = index + 1;
                const monthlyPoints = user.monthlyPoints[monthKey] || 0;
                
                const item = document.createElement('div');
                item.className = `leaderboard-item ${isCurrentUser ? 'current-user' : ''}`;
                item.innerHTML = `
                    <div class="leaderboard-rank rank-${rank}">${rank}</div>
                    <div class="leaderboard-user">
                        <strong>${user.firstName} ${user.lastName?.charAt(0) || ''}.</strong>
                        <span>${monthlyPoints} points this month</span>
                    </div>
                    <div class="leaderboard-points">${monthlyPoints}</div>
                `;
                
                container.appendChild(item);
            });
        }
        
        function loadEventsList(user) {
            const container = document.getElementById('eventsList');
            const userEvents = user.events || [];
            
            // Helper function to parse Danish date format
            function parseDanishDate(dateStr) {
                const datePart = dateStr.split(' - ')[0];
                const [day, month, year] = datePart.split('/').map(num => parseInt(num, 10));
                return new Date(year, month - 1, day, 23, 59, 59);
            }
            
            // Filter out past events
            const today = new Date();
            const upcomingEventIds = userEvents.filter(eventId => {
                const event = typeof eventData !== 'undefined' ? eventData.find(e => e.id === eventId) : null;
                if (!event || !event.date) return false;
                return parseDanishDate(event.date) >= today;
            });
            
            if (upcomingEventIds.length === 0) {
                container.innerHTML = `
                    <div class="no-events">You haven't signed up for any upcoming events.</div>
                `;
                return;
            }
            
            // Load actual events data from events.js
            container.innerHTML = '';
            
            upcomingEventIds.forEach(eventId => {
                // Find the event in eventData (from events.js)
                const event = typeof eventData !== 'undefined' ? eventData.find(e => e.id === eventId) : null;
                
                const eventItem = document.createElement('div');
                eventItem.className = 'event-item';
                eventItem.innerHTML = `
                    <span class="event-name">${event ? event.name : `Event #${eventId}`}</span>
                    <span class="event-points">+10 pts (signup)</span>
                `;
                container.appendChild(eventItem);
            });
        }
        
        function loadPointsHistory(user) {
            const tbody = document.getElementById('historyTableBody');
            const history = user.pointsHistory || [];
            
            if (history.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 30px; color: var(--dark-gray);">
                            No points history yet. Start earning points by checking in daily and attending events!
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by date (newest first)
            history.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = '';
            
            history.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(item.date)}</td>
                    <td>${item.description}</td>
                    <td class="${item.type === 'earned' || item.type === 'bonus' ? 'points-positive' : 'points-negative'}">
                        ${item.type === 'earned' || item.type === 'bonus' ? '+' : '-'}${item.points}
                    </td>
                    <td>
                        <span style="display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; 
                               background-color: ${getTypeColor(item.type)}; color: white;">
                            ${item.type}
                        </span>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function calculateImpactStats(user) {
            // Calculate based on points and activities
            const points = user.points || 0;
            
            // Rough estimates:
            // - 10 points = 1 kg CO2 saved
            // - 10 points = 50 L water saved  
            // - 10 points = 0.5 kg waste diverted
            // - 100 kg CO2 = 1 tree equivalent
            
            const co2Saved = (points / 10) * 1; // kg
            const waterSaved = (points / 10) * 50; // liters
            const wasteDiverted = (points / 10) * 0.5; // kg
            const equivalentTrees = Math.floor(co2Saved / 100);
            
            document.getElementById('co2Saved').textContent = `${co2Saved.toFixed(1)} kg`;
            document.getElementById('waterSaved').textContent = `${waterSaved.toFixed(0)} L`;
            document.getElementById('wasteDiverted').textContent = `${wasteDiverted.toFixed(1)} kg`;
            document.getElementById('equivalentTrees').textContent = equivalentTrees;
        }
        
        function initHistoryFilters() {
            const tbody = document.getElementById('historyTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            document.getElementById('filterAll').addEventListener('click', function() {
                updateFilterButtons('all');
                rows.forEach(row => row.style.display = '');
            });
            
            document.getElementById('filterEarned').addEventListener('click', function() {
                updateFilterButtons('earned');
                rows.forEach(row => {
                    const pointsCell = row.querySelector('.points-positive');
                    row.style.display = pointsCell ? '' : 'none';
                });
            });
            
            document.getElementById('filterSpent').addEventListener('click', function() {
                updateFilterButtons('spent');
                rows.forEach(row => {
                    const pointsCell = row.querySelector('.points-negative');
                    row.style.display = pointsCell ? '' : 'none';
                });
            });
        }
        
        function updateFilterButtons(activeFilter) {
            const buttons = ['filterAll', 'filterEarned', 'filterSpent'];
            buttons.forEach(buttonId => {
                const btn = document.getElementById(buttonId);
                if (buttonId === `filter${activeFilter.charAt(0).toUpperCase() + activeFilter.slice(1)}`) {
                    btn.style.backgroundColor = 'var(--primary-green)';
                    btn.style.color = 'white';
                } else {
                    btn.style.backgroundColor = 'var(--light-gray)';
                    btn.style.color = 'var(--dark-green)';
                }
            });
        }
        
        // Helper functions
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        function getTypeColor(type) {
            const colors = {
                'earned': '#4CAF50',
                'bonus': '#FF9800',
                'spent': '#F44336',
                'redeemed': '#9C27B0'
            };
            return colors[type] || '#607D8B';
        }
        
        function showFullLeaderboard() {
            alert('Full leaderboard feature coming soon! For now, you can see the top 5 contributors above.');
            // In a real implementation, this would open a modal or navigate to a full leaderboard page
        }

        // Trash competition!!! ---------------------
        function initTrashCompetition(user) {
            const submitBtn = document.getElementById('submitTrashBtn');
            const trashInput = document.getElementById('trashUpload');
            const trashStatus = document.getElementById('trashStatus');
            const selectedFile = document.getElementById('selectedFile');
            const fileLabel = document.getElementById('fileLabel');

            // File input change handler
            trashInput.addEventListener('change', function() {
                if (this.files && this.files.length > 0) {
                    const fileName = this.files[0].name;
                    fileLabel.textContent = 'Photo selected ‚úì';
                    selectedFile.textContent = `üì∑ ${fileName}`;
                    selectedFile.style.display = 'block';
                } else {
                    fileLabel.textContent = 'Choose a photo or drag & drop';
                    selectedFile.style.display = 'none';
                }
            });

            submitBtn.addEventListener('click', async function() {
                const currentUser = window.auth.currentUser;
                if (!currentUser) {
                    trashStatus.textContent = '‚ö†Ô∏è Please log in first!';
                    trashStatus.className = 'trash-status error';
                    return;
                }

                if (!trashInput.files || trashInput.files.length === 0) {
                    trashStatus.textContent = '‚ö†Ô∏è Select a photo first!';
                    trashStatus.className = 'trash-status error';
                    return;
                }

                const file = trashInput.files[0];
                submitBtn.disabled = true;
                submitBtn.textContent = 'Uploading...';

                try {
                    // 1Ô∏è‚É£ Upload to Firebase Storage
                    const storageRef = ref(window.storage, `trashUploads/${currentUser.uid}/${Date.now()}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    const imageUrl = await getDownloadURL(storageRef);

                    // 2Ô∏è‚É£ Save submission record
                    await addDoc(collection(window.db, "uploads"), {
                        userId: currentUser.uid,
                        imageUrl: imageUrl,
                        status: "pending",
                        timestamp: serverTimestamp()
                    });

                    trashStatus.textContent = '‚úÖ Uploaded! Awaiting approval.';
                    trashStatus.className = 'trash-status success';
                    
                    // Reset form
                    trashInput.value = '';
                    selectedFile.style.display = 'none';
                    fileLabel.textContent = 'Choose a photo or drag & drop';
                } catch (err) {
                    trashStatus.textContent = 'Error: ' + err.message;
                    trashStatus.className = 'trash-status error';
                }

                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Your Contribution';
            });

            // Load initial trash stats
            updateTrashStats(user);
        }

        function updateTrashStats(user) {
            const allUsers = JSON.parse(localStorage.getItem('sustainalearn_users')) || [];
            const now = new Date();
            
            // Total submissions
            const totalSubmissions = (user.trashCollected || []).length;
            document.getElementById('trashPoints').textContent = totalSubmissions;
            
            // This month's submissions
            const thisMonth = (user.trashCollected || []).filter(t => {
                const tDate = new Date(t.date);
                return tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear();
            }).length;
            document.getElementById('trashThisMonth').textContent = thisMonth;
            
            // Calculate rank
            const userCounts = allUsers.map(u => {
                const trashThisMonth = (u.trashCollected || []).filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear();
                });
                return { username: u.username, count: trashThisMonth.length };
            });
            
            userCounts.sort((a, b) => b.count - a.count);
            const rank = userCounts.findIndex(u => u.username === user.username) + 1;
            
            if (rank > 0 && thisMonth > 0) {
                document.getElementById('trashRank').textContent = `#${rank}`;
            } else {
                document.getElementById('trashRank').textContent = '-';
            }
        }

        // Call this when DOM content is loaded
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = JSON.parse(localStorage.getItem('sustainalearn_currentUser'));
            if (currentUser) {
                initTrashCompetition(currentUser);
            }
        });

        function awardTrashCompetitionPoints() {
            const allUsers = JSON.parse(localStorage.getItem('sustainalearn_users')) || [];
            const now = new Date();
            const monthKey = `${now.getFullYear()}-${now.getMonth()}`;

            // Count submissions per user this month
            const userCounts = allUsers.map(u => {
                const trashThisMonth = (u.trashCollected || []).filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear();
                });
                return { username: u.username, count: trashThisMonth.length };
            });

            // Sort descending
            userCounts.sort((a, b) => b.count - a.count);

            // Award points to top 3
            const pointsForPlaces = [500, 250, 100];

            for (let i = 0; i < 3; i++) {
                if (userCounts[i] && userCounts[i].count > 0) {
                    const userIndex = allUsers.findIndex(u => u.username === userCounts[i].username);
                    if (userIndex !== -1) {
                        allUsers[userIndex].points = (allUsers[userIndex].points || 0) + pointsForPlaces[i];

                        // Add points history
                        if (!allUsers[userIndex].pointsHistory) allUsers[userIndex].pointsHistory = [];
                        allUsers[userIndex].pointsHistory.push({
                            date: now.toISOString().split('T')[0],
                            description: `Trash Challenge - Place #${i + 1}`,
                            points: pointsForPlaces[i],
                            type: 'bonus'
                        });
                    }
                }
            }

            // Save
            localStorage.setItem('sustainalearn_users', JSON.stringify(allUsers));
        }




    </script>
    <script src="events.js"></script>
</body>
</html>